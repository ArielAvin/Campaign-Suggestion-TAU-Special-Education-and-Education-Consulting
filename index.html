<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×¦×¢×ª ×§××¤×™×™×Ÿ ×©×™×•×•×§×™ | ××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ ××‘×™×‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Frank+Ruhl+Libre:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Add the Firebase products that you want to use
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged, 
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Your web app's Firebase configuration
        // IMPORTANT: Replace with your actual Firebase config object if __firebase_config is not available
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_FALLBACK_API_KEY", // Fallback if __firebase_config is missing
            authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
            projectId: "YOUR_FALLBACK_PROJECT_ID",
            storageBucket: "YOUR_FALLBACK_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FALLBACK_MESSAGING_SENDER_ID",
            appId: "YOUR_FALLBACK_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        // Request scope for Google Cloud Platform access, which might cover Gemini API.
        // This scope is broad; a more specific one for Generative Language API would be better if available.
        // The user will be asked to consent to this scope.
        googleProvider.addScope('https://www.googleapis.com/auth/cloud-platform');

        let currentUser = null;
        let googleAccessToken = null; // To store the Google OAuth Access Token

        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userDetailsDiv = document.getElementById('userDetails');
        const getRecommendationBtn = document.getElementById('getRecommendationBtn'); // Already exists

        // Function to attempt initial sign-in using platform-provided token or anonymously
        async function attemptInitialSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Successfully signed in with custom token.");
                } else {
                    console.log("__initial_auth_token not available, attempting anonymous sign-in.");
                    await signInAnonymously(auth);
                    console.log("Successfully signed in anonymously.");
                }
            } catch (error) {
                console.error("Error during initial sign-in (custom or anonymous):", error);
                // Fallback: if not signed in after attempts, try anonymous again if safe
                if (!auth.currentUser) {
                    try {
                        await signInAnonymously(auth);
                        console.log("Successfully signed in anonymously as a final fallback.");
                    } catch (anonError) {
                        console.error("Error during final anonymous sign-in fallback:", anonError);
                    }
                }
            }
        }


        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // User is signed into Firebase. This could be via Google, custom token, or anonymous.
                // We only care about googleAccessToken if the sign-in method was Google.
                // If it wasn't Google, googleAccessToken remains null.
                
                userDetailsDiv.textContent = `××—×•×‘×¨/×ª ×›: ${user.displayName || user.email || '××©×ª××© ×× ×•× ×™××™'}`;
                userDetailsDiv.style.display = 'block';
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'block';

                // Enable Gemini button if we have a Google access token
                getRecommendationBtn.disabled = !googleAccessToken;

            } else {
                // User is signed out from Firebase
                googleAccessToken = null;
                userDetailsDiv.textContent = '';
                userDetailsDiv.style.display = 'none';
                signInBtn.style.display = 'block';
                signOutBtn.style.display = 'none';
                getRecommendationBtn.disabled = true; // Disable if not signed in with Google
            }
        });

        signInBtn.addEventListener('click', () => {
            signInWithPopup(auth, googleProvider)
                .then((result) => {
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    if (credential) {
                        googleAccessToken = credential.accessToken; // IMPORTANT: Capture Google OAuth Access Token
                    }
                    // currentUser will be set by onAuthStateChanged
                    // UI will be updated by onAuthStateChanged
                    console.log("Google Sign-In successful, access token obtained.");
                    getRecommendationBtn.disabled = false; // Enable button
                }).catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    googleAccessToken = null;
                    getRecommendationBtn.disabled = true;
                    // Display error in modal
                    showModal("×©×’×™××ª ×”×ª×—×‘×¨×•×ª", `<p class="text-red-600 text-center">××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×”×”×ª×—×‘×¨×•×ª ×¢× ×’×•×’×œ: ${error.code} - ${error.message}</p>`);
                });
        });

        signOutBtn.addEventListener('click', () => {
            const wasGoogleSignIn = auth.currentUser && auth.currentUser.providerData.some(p => p.providerId === GoogleAuthProvider.PROVIDER_ID);
            signOut(auth).then(() => {
                googleAccessToken = null; // Clear access token on sign out
                // UI will be updated by onAuthStateChanged
                console.log("Sign-out successful.");
                if (wasGoogleSignIn) {
                    // If they signed out from a Google session, re-attempt initial anonymous/custom token sign-in
                    // to maintain a Firebase session as per platform expectations.
                    attemptInitialSignIn();
                }
            }).catch((error) => {
                console.error("Sign Out Error:", error);
            });
        });

        // Call initial sign-in on page load
        attemptInitialSignIn();

    </script>
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f0f9ff; /* Tailwind sky-50 for a light, inviting background */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            text-align: center;
        }
        .font-frank { font-family: 'Frank Ruhl Libre', serif; }
        .card {
            background-color: white;
            padding: 2rem; /* Increased padding */
            border-radius: 0.75rem; /* Slightly larger rounding (rounded-xl) */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Tailwind shadow-2xl */
            width: 100%;
            max-width: 42rem; /* max-w-2xl */
        }
        .card h1 {
            font-family: 'Assistant', sans-serif;
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* bold */
            color: #0c4a6e; /* sky-800 */
            margin-bottom: 0.75rem; /* mb-3 */
        }
        @media (min-width: 640px) { /* sm */
            .card h1 {
                font-size: 2.75rem; /* ~text-4.5xl */
            }
        }
        .card p.intro-text { /* Added class for specific targeting */
            font-family: 'Frank Ruhl Libre', serif;
            font-size: 1.125rem; /* text-lg */
            color: #374151; /* gray-700 */
            margin-bottom: 1rem; /* Reduced margin */
            line-height: 1.75; /* leading-relaxed */
        }
        .auth-section {
            margin-bottom: 1.5rem;
            padding: 0.75rem;
            background-color: #f8fafc; /* slate-50 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        .auth-section button {
            font-family: 'Assistant', sans-serif;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        #signInBtn {
            background-color: #4285F4; /* Google Blue */
            color: white;
            border: none;
        }
        #signInBtn:hover {
            background-color: #357ae8;
        }
        #signOutBtn {
            background-color: #ef4444; /* red-500 */
            color: white;
            border: none;
        }
        #signOutBtn:hover {
            background-color: #dc2626; /* red-600 */
        }
        #userDetails {
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* gray-600 */
        }

        .button-container {
            display: flex;
            flex-direction: column; 
            gap: 1rem; 
            margin-top: 1rem; /* Reduced margin */
        }
        @media (min-width: 768px) { 
            .button-container {
                flex-direction: row; 
                justify-content: center;
                flex-wrap: wrap; 
            }
        }
        .nav-button {
            font-family: 'Assistant', sans-serif;
            font-weight: 600; 
            padding: 0.875rem 1.75rem; 
            border-radius: 0.5rem; 
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block; 
            width: 100%; 
            min-width: 200px; 
            border: 2px solid transparent; 
        }
        @media (min-width: 768px) { 
            .nav-button {
                width: auto; 
            }
        }
        .button-traditional {
            background-color: #0ea5e9; 
            color: white;
            border-color: #0ea5e9; 
        }
        .button-traditional:hover {
            background-color: #0284c7; 
            border-color: #0284c7; 
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(14, 165, 233, 0.2), 0 4px 6px -2px rgba(14, 165, 233, 0.1);
        }
        .button-interactive {
            background-color: #0d9488; 
            color: white;
            border-color: #0d9488; 
        }
        .button-interactive:hover {
            background-color: #0f766e; 
            border-color: #0f766e; 
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.2), 0 4px 6px -2px rgba(13, 148, 136, 0.1);
        }
        .button-podcast {
            background-color: #7c3aed; 
            color: white;
            border-color: #7c3aed; 
        }
        .button-podcast:hover {
            background-color: #6d28d9; 
            border-color: #6d28d9; 
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(124, 58, 237, 0.2), 0 4px 6px -2px rgba(124, 58, 237, 0.1);
        }
        .gemini-button-recommendation {
            font-family: 'Assistant', sans-serif;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            background-color: #db2777; 
            color: white;
            border: 2px solid #db2777;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-top: 1.5rem; 
            width: 100%;
            max-width: 300px; 
            display: block; 
            margin-left: auto;
            margin-right: auto;
        }
        .gemini-button-recommendation:hover:not(:disabled) {
            background-color: #be185d; 
            border-color: #be185d;
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(219, 39, 119, 0.2), 0 4px 6px -2px rgba(219, 39, 119, 0.1);
        }
        .gemini-button-recommendation:disabled {
            background-color: #fbcfe8; /* pink-200 */
            border-color: #fbcfe8;
            color: #9ca3af; /* gray-400 */
            cursor: not-allowed;
        }
        .logo-container {
            margin-bottom: 1.5rem; 
        }
        .logo-container img {
            height: 50px; 
            width: auto;
            margin: 0 auto; 
        }
        footer {
            margin-top: 3rem; 
            font-family: 'Frank Ruhl Libre', serif;
            font-size: 0.875rem; 
            color: #4b5563; 
        }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            width: 90%;
            max-width: 500px; 
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            direction: rtl;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.75rem;
        }
        .modal-title {
             font-family: 'Assistant', sans-serif;
             font-size: 1.25rem;
             font-weight: 600;
             color: #1e293b;
        }
        .modal-close-button {
            font-size: 1.75rem;
            font-weight: bold;
            color: #6b7280;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
        .modal-close-button:hover {
            color: #111827;
        }
        .modal-body {
             font-family: 'Frank Ruhl Libre', serif;
             font-size: 1rem;
             color: #374151;
             line-height: 1.75;
             white-space: pre-wrap;
        }
         .modal-body h3 {
            font-family: 'Assistant', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #0c4a6e;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .modal-body ul {
            list-style-type: disc;
            padding-right: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-body li {
            margin-bottom: 0.25rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #db2777; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="logo-container">
            <div class="text-2xl font-bold text-sky-700">××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ ××‘×™×‘</div>
            <div class="text-sm text-sky-600 font-frank">×”×¤×§×•×œ×˜×” ×œ××“×¢×™ ×”×¨×•×— | ×‘×™×ª ×”×¡×¤×¨ ×œ×—×™× ×•×š</div>
        </div>

        <h1>×”×¦×¢×ª ×§××¤×™×™×Ÿ ×©×™×•×•×§×™</h1>
        <p class="intro-text font-frank">
            ×ª×•××¨ ×©× ×™ ×‘×™×™×¢×•×¥ ×—×™× ×•×›×™ ×•×—×™× ×•×š ××™×•×—×“.
            <br>
            ×‘×—×¨×• ××ª ×’×¨×¡×ª ×”×ª×¦×•×’×” ×”××•×¢×“×¤×ª ×¢×œ×™×›×, ××• ×”×ª×—×‘×¨×• ×¢× ×’×•×’×œ ×œ×§×‘×œ×ª ×”××œ×¦×” ××™×©×™×ª:
        </p>

        <div class="auth-section">
            <button id="signInBtn">×”×ª×—×‘×¨/×™ ×¢× ×’×•×’×œ</button>
            <button id="signOutBtn" style="display:none;">×”×ª× ×ª×§/×™</button>
            <div id="userDetails" style="display:none;"></div>
        </div>

        <div class="button-container">
            <a href="campaign_proposal/Campaign_Suggestion.html" class="nav-button button-traditional">
                ğŸ“œ ×”×¦×’×” ××¡×•×¨×ª×™×ª
            </a>
            <a href="campaign_proposal/Campaign_Suggestion_Interactive.html" class="nav-button button-interactive">
                âœ¨ ×”×¦×’×” ××™× ×˜×¨××§×˜×™×‘×™×ª
            </a>
            <a href="campaign_proposal/podcast.html" class="nav-button button-podcast">
                ğŸ§ ×”××–× ×” ×œ×¤×•×“×§××¡×˜
            </a>
        </div>

        <button id="getRecommendationBtn" class="gemini-button-recommendation" disabled>
            âœ¨ ×§×‘×œ/×™ ×”××œ×¦×” ××™×©×™×ª ×œ×‘×—×™×¨×ª ×ª×¦×•×’×”
        </button>
        <p id="recommendationHint" class="text-xs text-gray-500 mt-2" style="display: block;">
            (×™×© ×œ×”×ª×—×‘×¨ ×¢× ×’×•×’×œ ×›×“×™ ×œ×”×¤×¢×™×œ ×ª×›×•× ×” ×–×•)
        </p>
    </div>

    <div id="geminiModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" class="modal-title">×”××œ×¦×ª ×¦×¤×™×™×”</h3>
                <button id="closeModalButton" class="modal-close-button">&times;</button>
            </div>
            <div id="modalBody" class="modal-body">
                </div>
        </div>
    </div>

    <footer>
        <p>&copy; <span id="currentYear"></span> ×”×¦×¢×” ×œ×§××¤×™×™×Ÿ ×©×™×•×•×§×™. ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª (×“×•×’××”).</p>
    </footer>

    <script type="module">
        // Firebase App (the core Firebase SDK) is always required and must be listed first
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Add the Firebase products that you want to use
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            onAuthStateChanged, 
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_FALLBACK_API_KEY",
            authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
            projectId: "YOUR_FALLBACK_PROJECT_ID",
            storageBucket: "YOUR_FALLBACK_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FALLBACK_MESSAGING_SENDER_ID",
            appId: "YOUR_FALLBACK_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        googleProvider.addScope('https://www.googleapis.com/auth/cloud-platform'); // Requesting general cloud platform scope

        let currentUser = null;
        let googleAccessToken = null; 

        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userDetailsDiv = document.getElementById('userDetails');
        const getRecommendationBtn = document.getElementById('getRecommendationBtn');
        const recommendationHint = document.getElementById('recommendationHint');
        
        const geminiModal = document.getElementById('geminiModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const closeModalButton = document.getElementById('closeModalButton');

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        function showModal(title, contentHTML) {
            modalTitle.textContent = title;
            modalBody.innerHTML = contentHTML;
            geminiModal.classList.add('visible');
        }

        function hideModal() {
            geminiModal.classList.remove('visible');
        }

        closeModalButton.addEventListener('click', hideModal);
        geminiModal.addEventListener('click', (event) => {
            if (event.target === geminiModal) {
                hideModal();
            }
        });
        
        async function attemptInitialSignIn() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token && __initial_auth_token.trim() !== "") {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Successfully signed in with custom token.");
                } else {
                    console.log("__initial_auth_token not available or empty, attempting anonymous sign-in.");
                    await signInAnonymously(auth);
                    console.log("Successfully signed in anonymously.");
                }
            } catch (error) {
                console.error("Error during initial sign-in (custom or anonymous):", error);
                if (!auth.currentUser) {
                    try {
                        await signInAnonymously(auth);
                        console.log("Successfully signed in anonymously as a final fallback.");
                    } catch (anonError) {
                        console.error("Error during final anonymous sign-in fallback:", anonError);
                    }
                }
            }
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // If user signed in with Google, googleAccessToken should already be set.
                // If not, it remains null.
                userDetailsDiv.textContent = `××—×•×‘×¨/×ª ×›: ${user.displayName || user.email || '××©×ª××©/×ª ×¨×©×•×/×”'}`;
                userDetailsDiv.style.display = 'block';
                signInBtn.style.display = 'none';
                signOutBtn.style.display = 'block';

                if (googleAccessToken) {
                    getRecommendationBtn.disabled = false;
                    recommendationHint.style.display = 'none';
                } else {
                    getRecommendationBtn.disabled = true;
                    recommendationHint.style.display = 'block';
                }
            } else {
                googleAccessToken = null;
                userDetailsDiv.textContent = '';
                userDetailsDiv.style.display = 'none';
                signInBtn.style.display = 'block';
                signOutBtn.style.display = 'none';
                getRecommendationBtn.disabled = true;
                recommendationHint.style.display = 'block';
            }
        });

        signInBtn.addEventListener('click', () => {
            signInWithPopup(auth, googleProvider)
                .then((result) => {
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    if (credential) {
                        googleAccessToken = credential.accessToken; 
                    }
                    // onAuthStateChanged will handle UI updates
                    console.log("Google Sign-In successful.");
                }).catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    googleAccessToken = null;
                    // onAuthStateChanged will handle UI updates for disabled button
                    showModal("×©×’×™××ª ×”×ª×—×‘×¨×•×ª", `<p class="text-red-600 text-center">××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×”×”×ª×—×‘×¨×•×ª ×¢× ×’×•×’×œ: ${error.message}</p><p class="text-xs text-gray-500 text-center mt-2">×•×“×/×™ ×©×—×¡×™××ª ×—×œ×•× ×•×ª ×§×•×¤×¦×™× ××‘×•×˜×œ×ª ×•× ×¡×”/×™ ×©×•×‘. ×™×™×ª×›×Ÿ ×©× ×“×¨×©×ª ×”×’×“×¨×” × ×•×¡×¤×ª ×‘-Google Cloud Console.</p>`);
                });
        });

        signOutBtn.addEventListener('click', () => {
            const wasGoogleSignIn = auth.currentUser && auth.currentUser.providerData.some(p => p.providerId === GoogleAuthProvider.PROVIDER_ID);
            signOut(auth).then(() => {
                console.log("Sign-out successful.");
                // googleAccessToken is cleared by onAuthStateChanged when user becomes null
                if (wasGoogleSignIn) {
                    attemptInitialSignIn(); // Re-establish baseline Firebase session
                }
            }).catch((error) => {
                console.error("Sign Out Error:", error);
            });
        });
        
        async function callGeminiAPIForRecommendation(prompt) {
            if (!googleAccessToken) {
                showModal("× ×“×¨×©×ª ×”×ª×—×‘×¨×•×ª", 
                    `<p class="text-center">×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×¢× ×—×©×‘×•×Ÿ ×’×•×’×œ ×›×“×™ ×œ×§×‘×œ ×”××œ×¦×” ××™×©×™×ª.</p>
                     <p class="text-xs text-gray-500 text-center mt-2">
                        ×× ×”×ª×—×‘×¨×ª ×•×¢×“×™×™×Ÿ ××•×¤×™×¢×” ×”×•×“×¢×” ×–×•, × ×¡×”/×™ ×œ×¨×¢× ×Ÿ ××ª ×”×“×£.
                        ×™×™×ª×›×Ÿ ×©× ×“×¨×© ××™×©×•×¨ ×”×¨×©××•×ª × ×•×¡×£ ××• ×§×™×™××ª ×‘×¢×™×™×ª ×ª×¦×•×¨×” ×‘×¦×“ ×”×©×¨×ª.
                     </p>`
                );
                return;
            }

            showModal("××¢×‘×“ ×‘×§×©×”...", '<div class="loading-spinner"></div><p class="text-center text-sm text-slate-500">×˜×•×¢×Ÿ ×”××œ×¦×” ×-Gemini...</p>');
            
            // Using the user's Google OAuth Access Token for Authorization
            // The API key parameter is removed from the URL.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent`; 
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${googleAccessToken}` // OAuth token
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text(); // Get raw error text for more info
                    console.error('Gemini API Error Response:', errorText);
                    let errorMessage = `×©×’×™××ª API: ${response.status} ${response.statusText}.`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage += ` ${errorData?.error?.message || ''}`;
                    } catch (e) {
                        // If error response is not JSON, use the raw text
                        errorMessage += ` ×¤×¨×˜×™×: ${errorText}`;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    let formattedText = result.candidates[0].content.parts[0].text;
                    formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>'); 
                    formattedText = formattedText.replace(/\n\n/g, '<br><br>');
                    formattedText = formattedText.replace(/\n/g, '<br>');
                    // More robust list formatting
                    formattedText = formattedText.replace(/<br>\s*([\*-])\s*(.*?)(?=(<br>\s*[\*-])|<br><br>|$)/g, (match, bullet, item) => `<li>${item.trim()}</li>`);
                    formattedText = formattedText.replace(/(<li>.*?<\/li>)+/g, (match) => `<ul>${match}</ul>`);
                    formattedText = formattedText.replace(/<\/ul>\s*<ul>/g, ''); // Consolidate adjacent lists
                    
                    return formattedText;

                } else {
                    console.error('Unexpected API response structure:', result);
                    throw new Error('××‘× ×” ×ª×©×•×‘×” ×œ× ×¦×¤×•×™ ××”-API.');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return `<p class="text-red-600 text-center">××™×¨×¢×” ×©×’×™××” ×‘×¢×ª ×¤× ×™×™×” ×œ-Gemini API: ${error.message}</p><p class="text-xs text-gray-500 text-center mt-2">×× × ×•×“×/×™ ×©×”×”×¨×©××•×ª ×”× ×“×¨×©×•×ª ×”×•×¢× ×§×• ×•×©×¤×¨×•×™×§×˜ Google Cloud ××•×’×“×¨ ×›×¨××•×™.</p>`;
            }
        }

        if (getRecommendationBtn) {
            getRecommendationBtn.addEventListener('click', async () => {
                if (!googleAccessToken) {
                     showModal("× ×“×¨×©×ª ×”×ª×—×‘×¨×•×ª", 
                        `<p class="text-center">×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×¢× ×—×©×‘×•×Ÿ ×’×•×’×œ ×›×“×™ ×œ×§×‘×œ ×”××œ×¦×” ××™×©×™×ª.</p>
                         <p class="text-xs text-gray-500 text-center mt-2">
                            ×œ×—×¥/×™ ×¢×œ "×”×ª×—×‘×¨/×™ ×¢× ×’×•×’×œ" ×œ××¢×œ×”.
                         </p>`
                    );
                    return;
                }

                const proposalTopic = "×”×¦×¢×” ×œ×§××¤×™×™×Ÿ ×©×™×•×•×§×™ ×œ×ª×•××¨ ×©× ×™ ×‘×™×™×¢×•×¥ ×—×™× ×•×›×™ ×•×—×™× ×•×š ××™×•×—×“ ×‘××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ ××‘×™×‘";
                const availableViews = [
                    { name: "×”×¦×’×” ××¡×•×¨×ª×™×ª", description: "×¡×§×™×¨×” ××¤×•×¨×˜×ª ×•××§×™×¤×” ×©×œ ×”×”×¦×¢×”, ××ª××™××” ×œ××™ ×©××¢×•× ×™×™×Ÿ ×‘×›×œ ×”×¤×¨×˜×™× ×•×¨×•×¦×” ×œ×§×¨×•× ××ª ×”×ª×•×›×Ÿ ×‘×¦×•×¨×” ×œ×™× ××¨×™×ª." },
                    { name: "×”×¦×’×” ××™× ×˜×¨××§×˜×™×‘×™×ª", description: "×—×•×•×™×” ×“×™× ××™×ª ×¢× ×˜×‘×œ××•×ª ××™× ×˜×¨××§×˜×™×‘×™×•×ª, ×ª×¨×©×™××™× ×•××¤×©×¨×•×™×•×ª ×”×¨×—×‘×” ×‘×××¦×¢×•×ª AI, ××ª××™××” ×œ××™ ×©××•×”×‘ ×œ×—×§×•×¨ ×•×œ×”×ª×¢××§ ×‘××•×¤×Ÿ ×¤×¢×™×œ ×‘× ×ª×•× ×™×." },
                    { name: "×”××–× ×” ×œ×¤×•×“×§××¡×˜", description: "×ª×§×¦×™×¨ ×§×•×œ×™ ×©×œ ×¢×™×§×¨×™ ×”×“×‘×¨×™×, ×›×•×œ×œ ××¤×©×¨×•×ª ×œ×”×¤×§×ª ×ª×•×‘× ×•×ª ×-AI. ××ª××™× ×œ××™ ×©××¢×“×™×£ ×”××–× ×”, × ××¦× ×‘×ª× ×•×¢×”, ××• ××¢×•× ×™×™×Ÿ ×‘×¡×§×™×¨×” ××”×™×¨×” ×•××™× ×˜×¨××§×˜×™×‘×™×ª." }
                ];

                let viewsDescription = availableViews.map(v => `* ${v.name}: ${v.description}`).join('\n');

                const prompt = `×©×œ×•×, ×× ×™ ××ª×¢× ×™×™×Ÿ ×‘-"${proposalTopic}".
                ×™×© ×œ×™ ×©×œ×•×© ××¤×©×¨×•×™×•×ª ×œ×¦×¨×•×š ××ª ×”××™×“×¢:
                ${viewsDescription}

                ×× × ×¡×¤×§ ×œ×™ ×”××œ×¦×” ×§×¦×¨×” (2-3 ××©×¤×˜×™×) ×©×ª×¢×–×•×¨ ×œ×™ ×œ×‘×—×•×¨ ××ª ×”×ª×¦×•×’×” ×”××ª××™××” ×‘×™×•×ª×¨ ×¢×‘×•×¨×™, ××•×œ×™ ×‘×”×ª×× ×œ×¡×•×’ ×”××™×“×¢ ×©×× ×™ ××—×¤×© ××• ×¡×’× ×•×Ÿ ×”×œ××™×“×” ×”××•×¢×“×£ ×¢×œ×™×™.
                ×œ××—×¨ ××›×Ÿ, ×× × ×¡×›× ×‘×§×¦×¨×” (××©×¤×˜ ××—×“ ××• ×©× ×™×™×) ××ª ××˜×¨×ª ×”×§××¤×™×™×Ÿ.
                ×”×©×‘ ×‘×¢×‘×¨×™×ª. ×”×©×ª××© ×‘×›×•×ª×¨×•×ª ×‘×¨×•×¨×•×ª (×œ×“×•×’××”, "**×”××œ×¦×”:**" ×•-"**××˜×¨×ª ×”×§××¤×™×™×Ÿ:**").`;
                
                const geminiResponse = await callGeminiAPIForRecommendation(prompt);
                showModal("âœ¨ ×”××œ×¦×ª ×¦×¤×™×™×” ××™×©×™×ª", geminiResponse);
            });
        }
        
        // Initial UI setup based on auth state
        attemptInitialSignIn();

    </script>
</body>
</html>
